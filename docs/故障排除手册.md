# 故障排除手册

## 📋 常见问题快速索引

### 🚨 紧急问题
- [服务无法启动](#服务无法启动)
- [数据库连接失败](#数据库连接失败)
- [内存不足](#内存不足)
- [磁盘空间不足](#磁盘空间不足)

### 🔧 配置问题
- [端口冲突](#端口冲突)
- [环境变量配置错误](#环境变量配置错误)
- [权限问题](#权限问题)
- [网络连接问题](#网络连接问题)

### 🐳 Docker相关
- [Docker服务异常](#docker服务异常)
- [容器启动失败](#容器启动失败)
- [镜像拉取失败](#镜像拉取失败)
- [卷挂载问题](#卷挂载问题)

### 🔄 CI/CD问题
- [GitLab访问问题](#gitlab访问问题)
- [Jenkins构建失败](#jenkins构建失败)
- [Pipeline执行错误](#pipeline执行错误)

---

## 🚨 紧急问题处理

### 服务无法启动

#### 问题描述
DevOps服务或应用服务无法正常启动

#### 诊断步骤
```bash
# 1. 检查Docker服务状态
docker version
docker info

# 2. 检查容器状态
docker ps -a
docker-compose -f docker-compose-devops.yml ps

# 3. 查看容器日志
docker logs gitlab-ce
docker logs jenkins
docker logs verto-mysql

# 4. 检查系统资源
docker system df
docker system events
```

#### 解决方案
```bash
# 方案1: 重启Docker服务
# Windows: 重启Docker Desktop
# 或者通过服务管理器重启Docker服务

# 方案2: 清理Docker资源
docker system prune -f
docker volume prune -f

# 方案3: 重新启动服务
docker-compose -f docker-compose-devops.yml down
docker-compose -f docker-compose-devops.yml up -d

# 方案4: 检查配置文件
docker-compose -f docker-compose-devops.yml config
```

#### 预防措施
- 定期清理Docker资源
- 监控系统资源使用情况
- 设置合适的资源限制

### 数据库连接失败

#### 问题描述
应用无法连接到MySQL数据库

#### 诊断步骤
```bash
# 1. 检查MySQL容器状态
docker ps | grep mysql
docker logs verto-mysql

# 2. 测试数据库连接
docker exec -it verto-mysql mysql -u root -p

# 3. 检查网络连接
docker network ls
docker network inspect verto_default

# 4. 验证配置
cat .env.devops | grep MYSQL
```

#### 解决方案
```bash
# 方案1: 重启MySQL容器
docker restart verto-mysql

# 方案2: 检查密码配置
# 确保.env.devops中的密码正确
MYSQL_ROOT_PASSWORD=your_password
MYSQL_PASSWORD=your_password

# 方案3: 重新初始化数据库
docker-compose -f docker-compose-devops.yml down -v
docker-compose -f docker-compose-devops.yml up -d

# 方案4: 手动创建数据库
docker exec -it verto-mysql mysql -u root -p
CREATE DATABASE IF NOT EXISTS verto;
GRANT ALL PRIVILEGES ON verto.* TO 'verto'@'%';
FLUSH PRIVILEGES;
```

#### 预防措施
- 定期备份数据库
- 监控数据库连接数
- 设置合适的连接池配置

### 内存不足

#### 问题描述
系统内存不足导致服务异常

#### 诊断步骤
```bash
# 1. 检查系统内存使用
docker stats
docker system df

# 2. 检查容器资源限制
docker inspect gitlab-ce | grep -i memory
docker inspect jenkins | grep -i memory

# 3. 查看Windows内存使用
# 任务管理器 -> 性能 -> 内存
```

#### 解决方案
```bash
# 方案1: 调整容器内存限制
# 编辑docker-compose-devops.yml
services:
  gitlab:
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

# 方案2: 清理不用的容器和镜像
docker container prune -f
docker image prune -f
docker system prune -a -f

# 方案3: 重启Docker Desktop
# 释放内存资源

# 方案4: 增加虚拟内存
# Windows设置 -> 系统 -> 高级系统设置 -> 性能设置 -> 虚拟内存
```

#### 预防措施
- 监控内存使用情况
- 设置合适的资源限制
- 定期清理无用资源

### 磁盘空间不足

#### 问题描述
磁盘空间不足导致服务异常

#### 诊断步骤
```bash
# 1. 检查磁盘使用情况
docker system df
dir C:\ /s

# 2. 查找大文件
# 使用WinDirStat或类似工具

# 3. 检查Docker数据目录
# 默认位置: C:\ProgramData\Docker
```

#### 解决方案
```bash
# 方案1: 清理Docker资源
docker system prune -a -f --volumes

# 方案2: 清理日志文件
# 删除或压缩旧的日志文件
docker logs gitlab-ce 2>/dev/null | wc -l

# 方案3: 移动Docker数据目录
# Docker Desktop -> Settings -> Resources -> Advanced
# 更改数据目录位置

# 方案4: 清理临时文件
# 删除Windows临时文件
# %TEMP%, %TMP%目录
```

#### 预防措施
- 定期清理Docker资源
- 设置日志轮转
- 监控磁盘使用情况

---

## 🔧 配置问题处理

### 端口冲突

#### 问题描述
服务启动时提示端口已被占用

#### 诊断步骤
```bash
# 1. 检查端口占用
netstat -ano | findstr :8080
netstat -ano | findstr :8081

# 2. 查看进程信息
tasklist /FI "PID eq 进程ID"

# 3. 检查Docker端口映射
docker ps --format "table {{.Names}}\t{{.Ports}}"
```

#### 解决方案
```bash
# 方案1: 修改端口配置
# 编辑docker-compose-devops.yml
services:
  gitlab:
    ports:
      - "8082:80"  # 改为其他端口

# 方案2: 停止占用端口的进程
taskkill /PID 进程ID /F

# 方案3: 使用不同的端口
# 编辑.env.devops
GITLAB_HTTP_PORT=8082
JENKINS_HTTP_PORT=8083

# 方案4: 重启网络服务
# 以管理员身份运行
netsh winsock reset
```

#### 预防措施
- 使用标准化的端口分配
- 文档化端口使用情况
- 使用端口检查脚本

### 环境变量配置错误

#### 问题描述
环境变量配置不正确导致服务异常

#### 诊断步骤
```bash
# 1. 检查环境变量文件
cat .env.devops
type .env.devops

# 2. 验证变量是否生效
docker-compose -f docker-compose-devops.yml config

# 3. 检查容器内环境变量
docker exec -it gitlab-ce env | grep GITLAB
docker exec -it jenkins env | grep JENKINS
```

#### 解决方案
```bash
# 方案1: 重新创建环境变量文件
copy .env.example .env.devops
# 重新配置所有变量

# 方案2: 验证变量格式
# 确保没有空格和特殊字符
MYSQL_ROOT_PASSWORD=password123
# 不要有空格: MYSQL_ROOT_PASSWORD = password123

# 方案3: 重新加载配置
docker-compose -f docker-compose-devops.yml down
docker-compose -f docker-compose-devops.yml --env-file .env.devops up -d

# 方案4: 使用默认值
# 在docker-compose.yml中设置默认值
environment:
  - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-defaultpassword}
```

#### 预防措施
- 使用配置验证脚本
- 提供配置模板
- 文档化所有配置项

### 权限问题

#### 问题描述
文件或目录权限不足

#### 诊断步骤
```bash
# 1. 检查文件权限
# Windows文件属性 -> 安全

# 2. 检查Docker权限
# Docker Desktop -> Settings -> General -> Use the WSL 2 based engine

# 3. 检查容器内权限
docker exec -it gitlab-ce ls -la /var/opt/gitlab
```

#### 解决方案
```bash
# 方案1: 修改文件权限
# 右键文件/文件夹 -> 属性 -> 安全 -> 编辑
# 给予当前用户完全控制权限

# 方案2: 以管理员身份运行
# 右键命令提示符 -> 以管理员身份运行

# 方案3: 修改Docker配置
# Docker Desktop -> Settings -> Resources -> File sharing
# 添加项目目录到共享列表

# 方案4: 重新创建目录
rmdir /s gitlab
mkdir gitlab\config gitlab\logs gitlab\data
```

#### 预防措施
- 使用标准的目录结构
- 设置合适的权限
- 使用专用的服务账户

### 网络连接问题

#### 问题描述
容器间网络连接异常

#### 诊断步骤
```bash
# 1. 检查Docker网络
docker network ls
docker network inspect verto_default

# 2. 测试容器间连接
docker exec -it jenkins ping gitlab
docker exec -it gitlab-ce ping jenkins

# 3. 检查防火墙设置
# Windows防火墙设置

# 4. 检查DNS解析
docker exec -it jenkins nslookup gitlab
```

#### 解决方案
```bash
# 方案1: 重新创建网络
docker network rm verto_default
docker-compose -f docker-compose-devops.yml up -d

# 方案2: 使用IP地址连接
# 获取容器IP
docker inspect gitlab-ce | grep IPAddress

# 方案3: 配置自定义网络
# 在docker-compose.yml中定义网络
networks:
  verto-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# 方案4: 检查防火墙规则
# 允许Docker通过防火墙
```

#### 预防措施
- 使用自定义网络
- 文档化网络配置
- 定期测试网络连接

---

## 🐳 Docker相关问题

### Docker服务异常

#### 问题描述
Docker Desktop无法正常工作

#### 诊断步骤
```bash
# 1. 检查Docker状态
docker version
docker info

# 2. 查看Docker日志
# Docker Desktop -> Troubleshoot -> Show logs

# 3. 检查WSL2状态（如果使用）
wsl --list --verbose
```

#### 解决方案
```bash
# 方案1: 重启Docker Desktop
# 右键系统托盘Docker图标 -> Restart

# 方案2: 重置Docker Desktop
# Docker Desktop -> Troubleshoot -> Reset to factory defaults

# 方案3: 更新Docker Desktop
# 下载最新版本并安装

# 方案4: 检查系统要求
# 确保Windows版本支持
# 确保启用了虚拟化
```

#### 预防措施
- 定期更新Docker Desktop
- 监控Docker服务状态
- 备份Docker配置

### 容器启动失败

#### 问题描述
容器无法正常启动

#### 诊断步骤
```bash
# 1. 查看容器状态
docker ps -a

# 2. 查看容器日志
docker logs container_name
docker logs --tail 50 container_name

# 3. 检查容器配置
docker inspect container_name

# 4. 测试镜像
docker run -it --rm image_name /bin/sh
```

#### 解决方案
```bash
# 方案1: 重新启动容器
docker restart container_name

# 方案2: 重新创建容器
docker rm container_name
docker-compose -f docker-compose-devops.yml up -d

# 方案3: 检查资源限制
# 增加内存和CPU限制

# 方案4: 更新镜像
docker pull image_name
docker-compose -f docker-compose-devops.yml up -d --force-recreate
```

#### 预防措施
- 设置健康检查
- 监控容器状态
- 使用稳定的镜像版本

### 镜像拉取失败

#### 问题描述
无法从Docker Hub拉取镜像

#### 诊断步骤
```bash
# 1. 测试网络连接
ping docker.io
nslookup docker.io

# 2. 检查Docker配置
docker info | grep -i proxy

# 3. 测试手动拉取
docker pull hello-world
```

#### 解决方案
```bash
# 方案1: 配置镜像加速器
# Docker Desktop -> Settings -> Docker Engine
{
  "registry-mirrors": [
    "https://mirror.ccs.tencentyun.com",
    "https://docker.mirrors.ustc.edu.cn"
  ]
}

# 方案2: 配置代理
# Docker Desktop -> Settings -> Resources -> Proxies

# 方案3: 使用本地镜像
# 从其他机器导出镜像
docker save -o gitlab.tar gitlab/gitlab-ce:latest
docker load -i gitlab.tar

# 方案4: 重试拉取
docker pull --retry 3 image_name
```

#### 预防措施
- 配置镜像加速器
- 缓存常用镜像
- 使用私有镜像仓库

### 卷挂载问题

#### 问题描述
Docker卷挂载失败或数据丢失

#### 诊断步骤
```bash
# 1. 检查卷状态
docker volume ls
docker volume inspect volume_name

# 2. 检查挂载点
docker inspect container_name | grep -i mount

# 3. 验证文件权限
# 检查宿主机目录权限
```

#### 解决方案
```bash
# 方案1: 重新创建卷
docker volume rm volume_name
docker-compose -f docker-compose-devops.yml up -d

# 方案2: 使用绝对路径
# 在docker-compose.yml中使用绝对路径
volumes:
  - D:\github_workspace\Verto\gitlab\data:/var/opt/gitlab

# 方案3: 修改权限
# 确保目录有正确的权限

# 方案4: 备份和恢复数据
# 从备份恢复数据
```

#### 预防措施
- 定期备份数据卷
- 使用命名卷
- 文档化卷配置

---

## 🔄 CI/CD问题处理

### GitLab访问问题

#### 问题描述
无法访问GitLab Web界面

#### 诊断步骤
```bash
# 1. 检查GitLab容器状态
docker ps | grep gitlab
docker logs gitlab-ce

# 2. 测试端口连接
telnet localhost 8080
curl -I http://localhost:8080

# 3. 检查GitLab配置
docker exec -it gitlab-ce cat /etc/gitlab/gitlab.rb
```

#### 解决方案
```bash
# 方案1: 重启GitLab容器
docker restart gitlab-ce

# 方案2: 重新配置GitLab
docker exec -it gitlab-ce gitlab-ctl reconfigure

# 方案3: 检查初始密码
docker exec -it gitlab-ce cat /etc/gitlab/initial_root_password

# 方案4: 重置GitLab
docker-compose -f docker-compose-devops.yml down
docker volume rm verto_gitlab_data
docker-compose -f docker-compose-devops.yml up -d
```

#### 预防措施
- 备份GitLab配置
- 监控GitLab状态
- 定期更新GitLab

### Jenkins构建失败

#### 问题描述
Jenkins构建任务失败

#### 诊断步骤
```bash
# 1. 查看构建日志
# Jenkins -> 项目 -> 构建历史 -> Console Output

# 2. 检查Jenkins状态
docker logs jenkins

# 3. 验证工具安装
# Jenkins -> Manage Jenkins -> Global Tool Configuration

# 4. 检查权限
# Jenkins -> Manage Jenkins -> Configure Global Security
```

#### 解决方案
```bash
# 方案1: 重新运行构建
# Jenkins -> 项目 -> Build Now

# 方案2: 检查构建脚本
# 验证Jenkinsfile语法
# 检查构建命令

# 方案3: 更新插件
# Jenkins -> Manage Jenkins -> Manage Plugins

# 方案4: 重启Jenkins
docker restart jenkins
```

#### 预防措施
- 定期备份Jenkins配置
- 监控构建状态
- 使用构建模板

### Pipeline执行错误

#### 问题描述
CI/CD Pipeline执行失败

#### 诊断步骤
```bash
# 1. 查看Pipeline日志
# GitLab -> CI/CD -> Pipelines -> 失败的Pipeline

# 2. 检查.gitlab-ci.yml语法
# GitLab -> CI/CD -> Editor

# 3. 验证Runner状态
# GitLab -> Settings -> CI/CD -> Runners

# 4. 检查变量配置
# GitLab -> Settings -> CI/CD -> Variables
```

#### 解决方案
```bash
# 方案1: 重新运行Pipeline
# GitLab -> CI/CD -> Pipelines -> Retry

# 方案2: 修复配置文件
# 检查.gitlab-ci.yml语法
# 验证环境变量

# 方案3: 注册新的Runner
docker exec -it gitlab-ce gitlab-runner register

# 方案4: 清理缓存
# GitLab -> CI/CD -> Pipelines -> Clear runner caches
```

#### 预防措施
- 验证Pipeline配置
- 监控Runner状态
- 使用Pipeline模板

---

## 🔧 诊断工具和脚本

### 系统诊断脚本

```bash
# diagnose.bat
@echo off
echo ========================================
echo Verto DevOps 系统诊断工具
echo ========================================

echo.
echo 1. 检查Docker状态...
docker version
if %errorlevel% neq 0 (
    echo ❌ Docker未正常运行
    goto :end
) else (
    echo ✅ Docker运行正常
)

echo.
echo 2. 检查容器状态...
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

echo.
echo 3. 检查磁盘空间...
docker system df

echo.
echo 4. 检查网络连接...
docker network ls

echo.
echo 5. 检查服务健康状态...
curl -s -o nul -w "GitLab HTTP状态: %%{http_code}\n" http://localhost:8080
curl -s -o nul -w "Jenkins HTTP状态: %%{http_code}\n" http://localhost:8081

:end
echo.
echo 诊断完成！
pause
```

### 日志收集脚本

```bash
# collect-logs.bat
@echo off
set LOG_DIR=logs_%date:~0,4%%date:~5,2%%date:~8,2%_%time:~0,2%%time:~3,2%%time:~6,2%
mkdir %LOG_DIR%

echo 收集系统日志到 %LOG_DIR%...

echo 收集Docker信息...
docker info > %LOG_DIR%\docker-info.txt
docker ps -a > %LOG_DIR%\docker-ps.txt
docker images > %LOG_DIR%\docker-images.txt

echo 收集容器日志...
docker logs gitlab-ce > %LOG_DIR%\gitlab.log 2>&1
docker logs jenkins > %LOG_DIR%\jenkins.log 2>&1
docker logs verto-mysql > %LOG_DIR%\mysql.log 2>&1

echo 收集配置文件...
copy .env.devops %LOG_DIR%\
copy docker-compose-devops.yml %LOG_DIR%\

echo 日志收集完成！目录: %LOG_DIR%
```

### 性能监控脚本

```bash
# monitor.bat
@echo off
:loop
cls
echo ========================================
echo Verto DevOps 性能监控
echo 时间: %date% %time%
echo ========================================

echo.
echo 容器资源使用情况:
docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}"

echo.
echo 磁盘使用情况:
docker system df

echo.
echo 网络连接测试:
ping -n 1 localhost > nul && echo ✅ 本地连接正常 || echo ❌ 本地连接异常

timeout /t 10 > nul
goto :loop
```

---

## 📞 获取帮助

### 联系方式
- **技术支持**: support@verto.com
- **文档中心**: https://docs.verto.com
- **社区论坛**: https://community.verto.com

### 报告问题
1. 使用诊断脚本收集信息
2. 描述问题现象和重现步骤
3. 提供错误日志和配置文件
4. 说明环境信息（操作系统、Docker版本等）

### 紧急联系
- **24/7技术热线**: +86-400-xxx-xxxx
- **紧急邮箱**: emergency@verto.com

---

## 💡 预防性维护

### 定期检查清单
- [ ] 检查Docker服务状态
- [ ] 清理无用的容器和镜像
- [ ] 备份重要数据
- [ ] 更新系统和软件
- [ ] 监控资源使用情况
- [ ] 检查日志文件大小
- [ ] 验证备份完整性
- [ ] 测试恢复流程

### 监控指标
- CPU使用率 < 80%
- 内存使用率 < 85%
- 磁盘使用率 < 90%
- 网络延迟 < 100ms
- 服务可用性 > 99.9%

通过遵循这个故障排除手册，您可以快速诊断和解决Verto DevOps环境中的常见问题。